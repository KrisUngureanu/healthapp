<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout.html}">
<head>
    <title>Пациент</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root{ --gradA:#4364f7; --gradB:#6fb1fc; }

        .btn-gradient{ background:linear-gradient(90deg,var(--gradA),var(--gradB)); border:none; color:#fff }
        .btn-gradient:hover{ background:linear-gradient(90deg,var(--gradB),var(--gradA)); color:#fff }
        .card{ border:none; border-radius:1rem; box-shadow:0 6px 20px rgba(0,0,0,.15) }
        .card-header{ border-radius:1rem 1rem 0 0; background:linear-gradient(90deg,var(--gradA),var(--gradB)); color:#fff }
        .stat{ border-radius:.75rem; background:#fff5ff; padding:1rem; display:flex; align-items:center; gap:.75rem }
        .stat .num{ font-weight:700; font-size:1.25rem }

        /* ТАБЫ: контрастный вид на светлом фоне */
        .nav-pills{ gap:.5rem }
        .nav-pills .nav-link{
            color:#2945e3;                /* обычный цвет текста */
            background:#f3f6ff;           /* светлый бейдж */
            border:1px solid #dfe6ff;
            border-radius:2rem;
            transition:.2s;
        }
        .nav-pills .nav-link:hover{
            color:#1c2fd1;
            background:#eaf0ff;
            border-color:#d3dcff;
        }
        .nav-pills .nav-link.active{
            color:#fff !important;
            background:linear-gradient(90deg,var(--gradA),var(--gradB)) !important;
            border-color:transparent;
            box-shadow:0 6px 16px rgba(67,100,247,.25);
        }

        /* холст графиков компактнее */
        .spark-wrap{ height:90px; }
        .spark-wrap canvas{ width:100% !important; height:100% !important; }
    </style>
</head>
<body>
<div layout:fragment="mainFragment" th:with="st=${(patient.status ?: '').toLowerCase()}">

    <!-- Шапка -->
    <div class="card mb-4">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <a th:href="@{/}" class="btn btn-sm btn-light border">← Назад</a>
                <div>
                    <h4 class="mb-0" th:text="${patient.fullname}">ФИО пациента</h4>
                    <small class="opacity-75">ID: <span th:text="${patient.id}">1</span></small>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2">
        <span class="badge"
              th:with="st=${(patient.status ?: '').toLowerCase()}"
              th:text="${st != '' ? patient.status : '—'}"
              th:classappend="${st == 'active'} ? ' bg-success' : (st == 'critical' ? ' bg-danger' : ' bg-secondary')">—</span>

                <div sec:authorize="hasAnyRole('DOCTOR','ADMIN')" class="d-flex gap-2">
                    <form th:action="@{/patients/{id}/integrations/{provider}/syncAll(id=${patient.id}, provider='oura')}"
                          method="post" class="d-flex gap-2 mb-0">
                        <input type="number" min="1" max="30" name="days" value="7" class="form-control" style="max-width:120px">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn btn-gradient">Синхронизировать</button>
                    </form>

                    <form th:if="${st == 'active'}"
                          th:action="@{/patients/{id}/{provider}/disconnect(id=${patient.id}, provider='oura')}"
                          method="post" class="mb-0">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn btn-outline-light">Отключить Oura</button>
                    </form>

                    <div th:if="${st != 'active'}" class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-light"
                                th:attr="data-url=@{/patients/{id}/oura/invite(id=${patient.id})}"
                                onclick="copyInviteUrl(this)">Скопировать приглашение</button>
                        <a class="btn btn-light"
                           th:href="@{/patients/{id}/oura/invite(id=${patient.id})}" target="_blank">Открыть приглашение</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Быстрые показатели -->
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6 col-md-3">
                    <div class="stat">
                        <div class="num"
                             th:text="${#lists.isEmpty(m.activityDaily) ? '—' : (m.activityDaily.get(0).steps != null ? m.activityDaily.get(0).steps : '—')}">—</div>
                        <div>Шаги<br><small class="text-muted">сегодня</small></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat">
                        <div class="num"
                             th:text="${#lists.isEmpty(m.readinessDaily) ? '—' : (m.readinessDaily.get(0).score != null ? m.readinessDaily.get(0).score : '—')}">—</div>
                        <div>Готовность<br><small class="text-muted">баллы</small></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat">
                        <div class="num"
                             th:text="${#lists.isEmpty(m.sleepDaily) ? '—' : (m.sleepDaily.get(0).totalSleepSec != null ? m.sleepDaily.get(0).totalSleepSec/60 : '—')}">—</div>
                        <div>Сон<br><small class="text-muted">минут сегодня</small></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat">
                        <div class="num" th:text="${#lists.isEmpty(m.hr) ? '—' : (m.hr.get(m.hr.size()-1).bpm)}">—</div>
                        <div>Пульс (послед.)<br>
                            <small class="text-muted"
                                   th:text="${#lists.isEmpty(m.hr) ? '' : T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(m.hr.get(m.hr.size()-1).ts, m.zone)}">—</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Табы -->
    <ul class="nav nav-pills mb-3 justify-content-center" id="patientTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-overview" data-bs-toggle="tab" data-bs-target="#pane-overview" type="button" role="tab">
                Обзор
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-series" data-bs-toggle="tab" data-bs-target="#pane-series" type="button" role="tab">
                Рядовые данные
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-daily" data-bs-toggle="tab" data-bs-target="#pane-daily" type="button" role="tab">
                Суточные
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-sessions" data-bs-toggle="tab" data-bs-target="#pane-sessions" type="button" role="tab">
                Сессии
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- Обзор -->
        <div class="tab-pane fade show active" id="pane-overview" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">ЧСС — сегодня</h6></div>
                        <div class="card-body">


                            <div th:if="${#lists.isEmpty(m.hr)}" class="alert alert-warning mb-0">Данных о пульсе за сегодня нет.</div>
                            <div th:if="${!#lists.isEmpty(m.hr)}" class="table-responsive">
                                <table class="table table-sm table-hover align-middle">
                                    <thead><tr><th>Провайдер</th><th>Время</th><th>BPM</th></tr></thead>
                                    <tbody>
                                    <tr th:each="h : ${m.hr}">
                                        <td th:text="${h.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(h.ts, m.zone)}">12:34</td>
                                        <td th:text="${h.bpm}">62</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">SpO₂ — сегодня</h6></div>
                        <div class="card-body">


                            <div th:if="${#lists.isEmpty(m.spo2)}" class="alert alert-warning mb-0">Данных SpO₂ за сегодня нет.</div>
                            <div th:if="${!#lists.isEmpty(m.spo2)}" class="table-responsive">
                                <table class="table table-sm table-hover align-middle">
                                    <thead><tr><th>Провайдер</th><th>Время</th><th>SpO₂, %</th></tr></thead>
                                    <tbody>
                                    <tr th:each="s : ${m.spo2}">
                                        <td th:text="${s.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(s.ts, m.zone)}">00:00</td>
                                        <td th:text="${#numbers.formatDecimal(s.spo2Pct,1,1)}">96.4</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Рядовые данные -->
        <div class="tab-pane fade" id="pane-series" role="tabpanel">
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">ЧСС — сегодня</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.hr)}" class="alert alert-warning mb-0">Нет рядовых данных по пульсу.</div>
                            <div th:if="${!#lists.isEmpty(m.hr)}" class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead><tr><th>Провайдер</th><th>Время</th><th>BPM</th></tr></thead>
                                    <tbody>
                                    <tr th:each="h : ${m.hr}">
                                        <td th:text="${h.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(h.ts, m.zone)}">12:34</td>
                                        <td th:text="${h.bpm}">62</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">SpO₂ — сегодня</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.spo2)}" class="alert alert-warning mb-0">Нет рядовых данных SpO₂.</div>
                            <div th:if="${!#lists.isEmpty(m.spo2)}" class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead><tr><th>Провайдер</th><th>Время</th><th>SpO₂, %</th></tr></thead>
                                    <tbody>
                                    <tr th:each="s : ${m.spo2}">
                                        <td th:text="${s.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(s.ts, m.zone)}">00:00</td>
                                        <td th:text="${#numbers.formatDecimal(s.spo2Pct,1,1)}">96.4</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Суточные -->
        <div class="tab-pane fade" id="pane-daily" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Активность (суточные)</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.activityDaily)}" class="text-muted">Нет суточных данных по активности.</div>
                            <div th:if="${!#lists.isEmpty(m.activityDaily)}" class="table-responsive">
                                <table class="table table-sm table-striped align-middle">
                                    <thead>
                                    <tr><th>Провайдер</th><th>Шаги</th><th>Ккал (акт.)</th><th>Дистанция, м</th></tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="a : ${m.activityDaily}">
                                        <td th:text="${a.provider}">OURA</td>
                                        <td th:text="${a.steps != null ? a.steps : 0}">0</td>
                                        <td th:text="${a.caloriesActive != null ? a.caloriesActive : 0}">0</td>
                                        <td th:text="${a.distanceM != null ? a.distanceM : 0}">0</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Готовность (суточные)</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.readinessDaily)}" class="text-muted">Нет суточных данных по готовности.</div>
                            <div th:if="${!#lists.isEmpty(m.readinessDaily)}" class="table-responsive">
                                <table class="table table-sm table-striped align-middle">
                                    <thead>
                                    <tr><th>Провайдер</th><th>Скор</th><th>RHR (уд/мин)</th><th>HRV (мс)</th></tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="r : ${m.readinessDaily}">
                                        <td th:text="${r.provider}">OURA</td>
                                        <td th:text="${r.score != null ? r.score : '—'}">—</td>
                                        <td th:text="${r.rhrBpm != null ? r.rhrBpm : '—'}">—</td>
                                        <td th:text="${r.hrvAvgMs != null ? r.hrvAvgMs : '—'}">—</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Сон (суточные)</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.sleepDaily)}" class="text-muted">Нет суточных данных по сну.</div>
                            <div th:if="${!#lists.isEmpty(m.sleepDaily)}" class="table-responsive">
                                <table class="table table-sm table-striped align-middle">
                                    <thead>
                                    <tr><th>Провайдер</th><th>Скор</th><th>Сон, мин</th><th>HRV (мс)</th></tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="s : ${m.sleepDaily}">
                                        <td th:text="${s.provider}">OURA</td>
                                        <td th:text="${s.score != null ? s.score : '—'}">—</td>
                                        <td th:text="${s.totalSleepSec != null ? s.totalSleepSec/60 : 0}">0</td>
                                        <td th:text="${s.hrvAvgMs != null ? s.hrvAvgMs : '—'}">—</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Сессии -->
        <div class="tab-pane fade" id="pane-sessions" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Тренировки — сегодня</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.activitySessions)}" class="alert alert-info mb-0">Тренировок за сегодня нет.</div>
                            <div th:if="${!#lists.isEmpty(m.activitySessions)}" class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead><tr>
                                        <th>Провайдер</th><th>Начало</th><th>Конец</th><th>Вид</th><th>Средн. пульс</th><th>Ккал</th><th>Дист., м</th>
                                    </tr></thead>
                                    <tbody>
                                    <tr th:each="w : ${m.activitySessions}">
                                        <td th:text="${w.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(w.startTime, m.zone)}">08:15</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(w.endTime, m.zone)}">09:05</td>
                                        <td th:text="${w.sportType}">run</td>
                                        <td th:text="${w.avgHr}">132</td>
                                        <td th:text="${w.calories}">450</td>
                                        <td th:text="${w.distanceM}">6000</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Эпизоды сна — сегодня</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.sleepSessions)}" class="alert alert-info mb-0">Эпизодов сна, начинающихся сегодня, нет.</div>
                            <div th:if="${!#lists.isEmpty(m.sleepSessions)}" class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead><tr>
                                        <th>Провайдер</th><th>Начало</th><th>Конец</th><th>Скор</th><th>Длит., мин</th><th>HRV</th>
                                    </tr></thead>
                                    <tbody>
                                    <tr th:each="s : ${m.sleepSessions}">
                                        <td th:text="${s.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(s.startTime, m.zone)}">23:41</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(s.endTime, m.zone)}">07:05</td>
                                        <td th:text="${s.score}">80</td>
                                        <td th:text="${s.durationSec != null ? s.durationSec/60 : '—'}">—</td>
                                        <td th:text="${s.hrvAvgMs}">45</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Скрытая форма (на будущее) -->
    <form id="syncForm"
          th:action="@{/patients/{id}/{provider}/sync(id=${patient.id}, provider='oura')}"
          method="post" class="d-none">
        <input type="hidden" name="type" id="syncType" value="sleep_daily">
        <input type="hidden" name="days" id="syncDays" value="7">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>

    <!-- Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080">
        <div id="inviteToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Приглашение</strong>
                <small class="text-muted">сейчас</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Закрыть"></button>
            </div>
            <div class="toast-body">—</div>
        </div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>

<script>
    function copyInviteUrl(btn) {
        const url = btn.getAttribute('data-url');
        if (!url) return;
        btn.disabled = true;
        fetch(url, { method: 'GET', credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
            .then(link => navigator.clipboard.writeText(link)
                .then(() => showInviteToast('Ссылка приглашения скопирована.'))
                .catch(() => { prompt('Скопируйте ссылку вручную:', link); }))
            .catch(() => showInviteToast('Не удалось получить ссылку.'))
            .finally(() => { btn.disabled = false; });
    }
    function showInviteToast(message) {
        const el = document.getElementById('inviteToast');
        if (!el) { alert(message); return; }
        el.querySelector('.toast-body').textContent = message;
        const t = new bootstrap.Toast(el, { delay: 2500 });
        t.show();
    }

    /* ==== Chart.js спарклайны ==== */
    function makeSparkline(canvasId, labels, values, opts={}) {
        const el = document.getElementById(canvasId);
        if (!el || !Array.isArray(values) || values.length === 0) return;
        const ctx = el.getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    data: values,
                    fill: false,
                    borderWidth: 2,
                    tension: 0.35,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (c) => (opts.unit ? `${c.parsed.y} ${opts.unit}` : `${c.parsed.y}`)
                        }
                    }
                },
                scales: {
                    x: { display: false },
                    y: {
                        display: false,
                        suggestedMin: opts.suggestedMin ?? undefined,
                        suggestedMax: opts.suggestedMax ?? undefined
                    }
                },
                elements: { line: { borderJoinStyle:'round', borderCapStyle:'round' } }
            }
        });
    }
    function readCsv(elId) {
        const el = document.getElementById(elId);
        if (!el) return { labels: [], values: [] };
        const labels = (el.dataset.labels || '').split(',').map(s => s.trim()).filter(Boolean);
        const values = (el.dataset.values || '').split(',').map(s => s.trim()).filter(Boolean).map(Number);
        return { labels, values };
    }

    // HR
    (function(){
        const {labels, values} = readCsv('hr-data');
        if (values.length) {
            makeSparkline('hrSpark', labels, values, {});
        }
    })();

    // SpO2
    (function(){
        const {labels, values} = readCsv('spo2-data');
        if (values.length) {
            const nums = values.filter(v => !isNaN(v));
            const pad = 0.5;
            const min = nums.length ? Math.min(...nums) - pad : undefined;
            const max = nums.length ? Math.max(...nums) + pad : undefined;
            makeSparkline('spo2Spark', labels, values, { unit:'%', suggestedMin:min, suggestedMax:max });
        }
    })();
</script>
</body>
</html>
