<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout.html}">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Пациент</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons (аккуратные иконки для кнопок) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --gradA: #4364f7;
            --gradB: #6fb1fc;
            --bg-soft: #f7f9ff;
            --card-shadow: 0 6px 20px rgba(0, 0, 0, .12);
            --radius-xl: 1rem;
            --radius-lg: .75rem;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-soft: #12141a;
            }
            body { background: #0e1117; color: #dee3ea; }
            .card { background: #0f1420; box-shadow: 0 12px 24px rgba(0,0,0,.35); }
            .table { --bs-table-striped-bg: rgba(255,255,255,.03); --bs-table-hover-bg: rgba(255,255,255,.05); }
            .nav-pills .nav-link { background: #111827; border-color: #1f2937; color: #c7d2fe; }
            .nav-pills .nav-link:hover { background: #111b2a; border-color: #24324a; }
            .alert-info { background: rgba(56, 189, 248, .08); border-color: rgba(56, 189, 248, .25); color: #a5d8ff; }
        }

        .btn-gradient { background: linear-gradient(90deg, var(--gradA), var(--gradB)); border: none; color: #fff }
        .btn-gradient:hover { background: linear-gradient(90deg, var(--gradB), var(--gradA)); color: #fff }

        .card { border: none; border-radius: var(--radius-xl); box-shadow: var(--card-shadow); }
        .card-header { border-radius: var(--radius-xl) var(--radius-xl) 0 0; background: linear-gradient(90deg, var(--gradA), var(--gradB)); color: #fff }

        .stat { border-radius: var(--radius-lg); background: var(--bg-soft); padding: 1rem; display: flex; align-items: center; gap: .75rem; min-height: 90px }
        .stat .num { font-weight: 700; font-size: 1.25rem }

        /* Пилюли табов */
        .nav-pills { gap: .5rem }
        .nav-pills .nav-link { color: #2945e3; background: #f3f6ff; border: 1px solid #dfe6ff; border-radius: 2rem; transition: .2s; }
        .nav-pills .nav-link:hover { color: #1c2fd1; background: #eaf0ff; border-color: #d3dcff; }
        .nav-pills .nav-link.active { color: #fff !important; background: linear-gradient(90deg, var(--gradA), var(--gradB)) !important; border-color: transparent; box-shadow: 0 6px 16px rgba(67, 100, 247, .25); }

        /* Таблицы */
        .table-responsive { position: relative; }
        .table thead th { position: sticky; top: 0; z-index: 2; background: rgba(255,255,255,.9); backdrop-filter: blur(6px); }
        @media (prefers-color-scheme: dark) { .table thead th { background: rgba(10,12,20,.75); } }
        .table-sm td, .table-sm th { padding: .45rem .6rem; }
        .table-fit { width: max-content; min-width: 100%; }

        /* Тени по краям скролла для подсказки, что есть горизонтальный скролл */
        .scroll-shadow:before, .scroll-shadow:after { content: ""; position: sticky; top: 0; width: 16px; height: 100%; pointer-events: none; z-index: 3; }
        .scroll-shadow:before { left: 0; box-shadow: inset 12px 0 12px -12px rgba(0,0,0,.25); }
        .scroll-shadow:after  { right: 0; box-shadow: inset -12px 0 12px -12px rgba(0,0,0,.25); }

        /* Спарклайны */
        .spark-wrap { height: 60px; margin-top: .35rem }
        .spark-wrap canvas { width: 100% !important; height: 100% !important; }
        .spark-wrap.big { height: 120px }

        /* Значки статуса */
        .badge-status { font-size: .875rem; padding: .5rem .75rem; border-radius: 2rem; }

        /* Плотность таблиц */
        .table-compact .table-sm td, .table-compact .table-sm th { padding: .25rem .4rem; font-size: .875rem; }
    </style>
</head>
<body>
<div layout:fragment="mainFragment" th:with="st=${(patient.status ?: '').toLowerCase()}">
    <!-- Хлебные крошки + заголовок -->
    <div class="card mb-4">
        <div class="card-header py-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div class="d-flex align-items-center gap-3">
                    <a th:href="@{/}" class="btn btn-sm btn-light border"><i class="bi bi-arrow-left"></i> Назад</a>
                    <div>
                        <h4 class="mb-0" th:text="${patient.fullname}">ФИО пациента</h4>
                        <small class="opacity-75">ID: <span th:text="${patient.id}">1</span></small>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-2 flex-wrap">
          <span class="badge badge-status"
                th:text="${st != '' ? patient.status : '—'}"
                th:classappend="${st == 'active'} ? ' bg-success' : (st == 'critical' ? ' bg-danger' : ' bg-secondary')">—</span>

                    <div class="vr d-none d-md-block"></div>

                    <!-- Кнопки действий врача/админа -->
                    <div class="d-flex align-items-center gap-2 flex-wrap" sec:authorize="hasAnyRole('DOCTOR','ADMIN')">
                        <!-- Отключения -->
                        <form th:if="${patient.status == 'active' and patient.device == 'oura'}"
                              th:action="@{/patients/{id}/{provider}/disconnect(id=${patient.id}, provider='oura')}" method="post" class="mb-0">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-outline-light"><i class="bi bi-power"></i> Отключить Oura</button>
                        </form>

                        <form th:if="${patient.status == 'active' and patient.device == 'whoop'}"
                              th:action="@{/patients/{id}/{provider}/disconnect(id=${patient.id}, provider='whoop')}" method="post" class="mb-0">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-outline-light"><i class="bi bi-power"></i> Отключить Whoop</button>
                        </form>

                        <form th:if="${patient.status == 'active' and patient.device == 'polar'}"
                              th:action="@{/patients/{id}/{provider}/disconnect(id=${patient.id}, provider='polar')}" method="post" class="mb-0">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-outline-light"><i class="bi bi-power"></i> Отключить Polar</button>
                        </form>

                        <form th:if="${st == 'active'}" th:action="@{/patients/{id}/integrations/{provider}/syncAll(id=${patient.id}, provider=${patient.device})}" method="post" class="mb-0">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-outline-light"><i class="bi bi-cloud-arrow-down"></i> Получить данные</button>
                        </form>

                        <form th:if="${st == 'active'}" th:action="@{/patients/{id}/integrations/{provider}/syncSleep(id=${patient.id}, provider=${patient.device})}" method="post" class="mb-0">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-outline-light"><i class="bi bi-cloud-arrow-down"></i> Получить данные Garmin</button>
                        </form>

                        <form th:if="${st == 'active'}"
                              th:action="@{/patients/{id}/integrations/{provider}/deleteUser(id=${patient.id}, provider=${patient.device})}"
                              method="post" class="mb-0">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <input type="hidden" name="_method" value="delete"/>
                            <button type="submit" class="btn btn-outline-light">
                                <i class="bi bi-cloud-arrow-down"></i> Удалить пользователя
                            </button>
                        </form>




                        <!-- Приглашения, если не активен -->
                        <div th:if="${patient.status != 'active'}" class="d-flex gap-2 flex-wrap">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-light"
                                        th:attr="data-url=@{/patients/{id}/oura/invite(id=${patient.id})}"
                                        onclick="copyInviteUrl(this)"><i class="bi bi-clipboard"></i> Скопировать Oura</button>
                                <a class="btn btn-light" th:href="@{/patients/{id}/oura/invite(id=${patient.id})}" target="_blank"><i class="bi bi-box-arrow-up-right"></i></a>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-light"
                                        th:attr="data-url=@{/patients/{id}/whoop/invite(id=${patient.id})}"
                                        onclick="copyInviteUrl(this)"><i class="bi bi-clipboard"></i> Скопировать Whoop</button>
                                <a class="btn btn-light" th:href="@{/patients/{id}/whoop/invite(id=${patient.id})}" target="_blank"><i class="bi bi-box-arrow-up-right"></i></a>
                            </div>
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-light"
                                        th:attr="data-url=@{/patients/{id}/polar/invite(id=${patient.id})}"
                                        onclick="copyInviteUrl(this)"><i class="bi bi-clipboard"></i> Скопировать Polar</button>
                                <a class="btn btn-light" th:href="@{/patients/{id}/polar/invite(id=${patient.id})}" target="_blank"><i class="bi bi-box-arrow-up-right"></i></a>
                            </div>

                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-light"
                                        th:attr="data-url=@{/patients/{id}/garmin/invite(id=${patient.id})}"
                                        onclick="copyInviteUrl(this)"><i class="bi bi-clipboard"></i> Скопировать Garmin</button>
                                <a class="btn btn-light" th:href="@{/patients/{id}/garmin/invite(id=${patient.id})}" target="_blank"><i class="bi bi-box-arrow-up-right"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>




    <div class="tab-content" id="providerTabsContent">
        <!-- OURA -->
        <div class="tab-pane fade show active"  th:if="${patient.device=='oura'}"  id="oura-pane" role="tabpanel" aria-labelledby="oura-tab">
            <div th:if="${patient.device == 'oura' and patient.status == 'active'}" class="d-flex flex-column gap-3">
                <div th:if="${#lists.isEmpty(ouraActivities)}" class="alert alert-info">Нет активностей за выбранный период.</div>
                <div th:if="${not #lists.isEmpty(ouraActivities)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Oura Activity</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-oura-activity','oura_activity.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-oura-activity-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-oura-activity-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-oura-activity" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Врем. метка</th>
                                <th>Шаги</th>
                                <th>Скор</th>
                                <th>Актив. калории</th>
                                <th>Средн. MET мин</th>
                                <th>Meet daily targets</th>
                                <th>Move every hour</th>
                                <th>Recovery time</th>
                                <th>Stay active</th>
                                <th>Training freq</th>
                                <th>Training volume</th>
                                <th>Экв. дистанция</th>
                                <th>High MET мин</th>
                                <th>High время</th>
                                <th>Неактив. алерты</th>
                                <th>Low MET мин</th>
                                <th>Low время</th>
                                <th>Medium MET мин</th>
                                <th>Medium время</th>
                                <th>До цели (м)</th>
                                <th>Non-wear время</th>
                                <th>Resting время</th>
                                <th>Sedentary MET</th>
                                <th>Sedentary время</th>
                                <th>Цель калории</th>
                                <th>Цель метры</th>
                                <th>Всего калорий</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="a : ${ouraActivities}">
                                <td th:text="${a.day}">2025-09-24</td>
                                <td th:text="${a.timeRecord != null ? #temporals.format(a.timeRecord, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${a.steps}">0</td>
                                <td th:text="${a.score}">0</td>
                                <td th:text="${a.active_calories}">0</td>
                                <td th:text="${#numbers.formatDecimal(a.average_met_minutes, 1, 2)}">0.00</td>
                                <td th:text="${a.meet_daily_targets}">0</td>
                                <td th:text="${a.move_every_hour}">0</td>
                                <td th:text="${a.recovery_time}">0</td>
                                <td th:text="${a.stay_active}">0</td>
                                <td th:text="${a.training_frequency}">0</td>
                                <td th:text="${a.training_volume}">0</td>
                                <td th:text="${a.equivalent_walking_distance}">0</td>
                                <td th:text="${a.high_activity_met_minutes}">0</td>
                                <td th:text="${a.high_activity_time}">0</td>
                                <td th:text="${a.inactivity_alerts}">0</td>
                                <td th:text="${a.low_activity_met_minutes}">0</td>
                                <td th:text="${a.low_activity_time}">0</td>
                                <td th:text="${a.medium_activity_met_minutes}">0</td>
                                <td th:text="${a.medium_activity_time}">0</td>
                                <td th:text="${a.meters_to_target}">0</td>
                                <td th:text="${a.non_wear_time}">0</td>
                                <td th:text="${a.resting_time}">0</td>
                                <td th:text="${a.sedentary_met_minutes}">0</td>
                                <td th:text="${a.sedentary_time}">0</td>
                                <td th:text="${a.target_calories}">0</td>
                                <td th:text="${a.target_meters}">0</td>
                                <td th:text="${a.total_calories}">0</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(ouraHeartRate)}" class="alert alert-info">Нет данных по сердцебиению за выбранный период.</div>
                <div th:if="${not #lists.isEmpty(ouraHeartRate)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Oura Heart Rate</strong>
                        <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-oura-hr','oura_heart_rate.csv')"><i class="bi bi-download"></i> CSV</button>
                    </div>
                    <div class="table-responsive scroll-shadow">
                        <table id="tbl-oura-hr" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead><tr><th>timeRecord</th><th>bpm</th><th>source</th></tr></thead>
                            <tbody>
                            <tr th:each="a : ${ouraHeartRate}">
                                <td th:text="${a.timeRecord != null ? #temporals.format(a.timeRecord, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${a.bpm}">0</td>
                                <td th:text="${a.source}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(ouraDaylySleep)}" class="alert alert-info">Нет данных по daily sleep.</div>
                <div th:if="${not #lists.isEmpty(ouraDaylySleep)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Oura Daily Sleep</strong>
                        <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-oura-dsleep','oura_daily_sleep.csv')"><i class="bi bi-download"></i> CSV</button>
                    </div>
                    <div class="table-responsive scroll-shadow">
                        <table id="tbl-oura-dsleep" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>deep_sleep</th><th>efficiency</th><th>latency</th><th>rem_sleep</th><th>restfulness</th><th>timing</th><th>total_sleep</th>
                                <th>day</th><th>score</th><th>timeRecord</th>
                            </tr></thead>
                            <tbody>
                            <tr th:each="s : ${ouraDaylySleep}">
                                <td th:text="${s.deep_sleep}">0</td>
                                <td th:text="${s.efficiency}">0</td>
                                <td th:text="${s.latency}">0</td>
                                <td th:text="${s.rem_sleep}">0</td>
                                <td th:text="${s.restfulness}">0</td>
                                <td th:text="${s.timing}">0</td>
                                <td th:text="${s.total_sleep}">0</td>
                                <td th:text="${s.day}">2025-09-24</td>
                                <td th:text="${s.score}">0</td>
                                <td th:text="${s.timeRecord != null ? #temporals.format(s.timeRecord, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(ouraSpo)}" class="alert alert-info">Нет данных по SpO₂ за выбранный период.</div>
                <div th:if="${not #lists.isEmpty(ouraSpo)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Oura SpO₂</strong>
                        <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-oura-spo','oura_spo2.csv')"><i class="bi bi-download"></i> CSV</button>
                    </div>
                    <div class="table-responsive scroll-shadow">
                        <table id="tbl-oura-spo" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead><tr><th>breathing_disturbance_index</th><th>day</th><th>spo2_percentage</th></tr></thead>
                            <tbody>
                            <tr th:each="a : ${ouraSpo}">
                                <td th:text="${a.breathing_disturbance_index}">0</td>
                                <td th:text="${a.day}">0</td>
                                <td th:text="${a.spo2_percentage}">0</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(ouraReadiness)}" class="alert alert-info">Нет данных по readiness.</div>
                <div th:if="${not #lists.isEmpty(ouraReadiness)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Oura Readiness</strong>
                        <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-oura-ready','oura_readiness.csv')"><i class="bi bi-download"></i> CSV</button>
                    </div>
                    <div class="table-responsive scroll-shadow">
                        <table id="tbl-oura-ready" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>activity_balance</th><th>body_temperature</th><th>hrv_balance</th><th>previous_day_activity</th>
                                <th>previous_night</th><th>recovery_index</th><th>resting_heart_rate</th><th>sleep_balance</th>
                                <th>sleep_regularity</th><th>day</th><th>score</th><th>timeRecord</th>
                            </tr></thead>
                            <tbody>
                            <tr th:each="r : ${ouraReadiness}">
                                <td th:text="${r.activity_balance}">0</td>
                                <td th:text="${r.body_temperature}">0</td>
                                <td th:text="${r.hrv_balance}">0</td>
                                <td th:text="${r.previous_day_activity}">0</td>
                                <td th:text="${r.previous_night}">0</td>
                                <td th:text="${r.recovery_index}">0</td>
                                <td th:text="${r.resting_heart_rate}">0</td>
                                <td th:text="${r.sleep_balance}">0</td>
                                <td th:text="${r.sleep_regularity}">0</td>
                                <td th:text="${r.day}">2025-09-24</td>
                                <td th:text="${r.score}">0</td>
                                <td th:text="${r.timeRecord != null ? #temporals.format(r.timeRecord, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(ouraSleep)}" class="alert alert-info">Нет данных по sleep.</div>
                <div th:if="${not #lists.isEmpty(ouraSleep)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Oura Sleep Sessions</strong>
                        <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-oura-sleep','oura_sleep.csv')"><i class="bi bi-download"></i> CSV</button>
                    </div>
                    <div class="table-responsive scroll-shadow">
                        <table id="tbl-oura-sleep" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>average_breath</th><th>average_heart_rate</th><th>average_hrv</th><th>awake_time</th>
                                <th>bedtime_end</th><th>bedtime_start</th><th>day</th><th>deep_sleep_duration</th>
                                <th>efficiency</th><th>latency</th><th>light_sleep_duration</th><th>lowest_heart_rate</th>
                                <th>activity_balance</th><th>body_temperature</th><th>hrv_balance</th><th>previous_day_activity</th>
                                <th>previous_night</th><th>recovery_index</th><th>resting_heart_rate</th><th>sleep_balance</th>
                                <th>score</th><th>temperature_deviation</th><th>readiness_score_delta</th><th>rem_sleep_duration</th>
                                <th>restless_periods</th><th>time_in_bed</th><th>total_sleep_duration</th><th>type</th>
                            </tr></thead>
                            <tbody>
                            <tr th:each="s : ${ouraSleep}">
                                <td th:text="${s.average_breath}">0.0</td>
                                <td th:text="${s.average_heart_rate}">0.0</td>
                                <td th:text="${s.average_hrv}">0</td>
                                <td th:text="${s.awake_time}">0</td>
                                <td th:text="${s.bedtime_end != null ? #temporals.format(s.bedtime_end,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${s.bedtime_start != null ? #temporals.format(s.bedtime_start,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${s.day}">2025-09-24</td>
                                <td th:text="${s.deep_sleep_duration}">0</td>
                                <td th:text="${s.efficiency}">0</td>
                                <td th:text="${s.latency}">0</td>
                                <td th:text="${s.light_sleep_duration}">0</td>
                                <td th:text="${s.lowest_heart_rate}">0</td>
                                <td th:text="${s.activity_balance}">0</td>
                                <td th:text="${s.body_temperature}">0</td>
                                <td th:text="${s.hrv_balance}">0</td>
                                <td th:text="${s.previous_day_activity}">0</td>
                                <td th:text="${s.previous_night}">0</td>
                                <td th:text="${s.recovery_index}">0</td>
                                <td th:text="${s.resting_heart_rate}">0</td>
                                <td th:text="${s.sleep_balance}">0</td>
                                <td th:text="${s.score}">0</td>
                                <td th:text="${s.temperature_deviation}">0.0</td>
                                <td th:text="${s.readiness_score_delta}">0</td>
                                <td th:text="${s.rem_sleep_duration}">0</td>
                                <td th:text="${s.restless_periods}">0</td>
                                <td th:text="${s.time_in_bed}">0</td>
                                <td th:text="${s.total_sleep_duration}">0</td>
                                <td th:text="${s.type}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- WHOOP -->
        <div class="tab-pane fade show active" th:if="${patient.device=='whoop'}" id="whoop-pane" role="tabpanel" aria-labelledby="whoop-tab">
            <div th:if="${patient.device == 'whoop' and patient.status == 'active'}" class="d-flex flex-column gap-3">
                <div th:if="${#lists.isEmpty(whoopCycles)}" class="alert alert-info">Нет данных по Whoop cycles.</div>
                <div th:if="${not #lists.isEmpty(whoopCycles)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>WHOOP Cycles</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-whoop-cycles','whoop_cycles.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-whoop-cycles-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-whoop-cycles-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-whoop-cycles" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>created_at</th><th>updated_at</th><th>start</th><th>enddate</th><th>timezone_offset</th>
                                <th>score_state</th><th>strain</th><th>kilojoule</th><th>average_heart_rate</th><th>max_heart_rate</th>
                            </tr></thead>
                            <tbody>
                            <tr th:each="c : ${whoopCycles}">
                                <td th:text="${c.created_at != null ? #temporals.format(c.created_at,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${c.updated_at != null ? #temporals.format(c.updated_at,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${c.start != null ? #temporals.format(c.start,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${c.enddate != null ? #temporals.format(c.enddate,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${c.timezone_offset}">+05:00</td>
                                <td th:text="${c.score_state}">SCORED</td>
                                <td th:text="${#numbers.formatDecimal(c.strain, 1, 2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(c.kilojoule, 1, 2)}">0.00</td>
                                <td th:text="${c.average_heart_rate}">0</td>
                                <td th:text="${c.max_heart_rate}">0</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(whoopRecovery)}" class="alert alert-info">Нет данных по recovery.</div>
                <div th:if="${not #lists.isEmpty(whoopRecovery)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>WHOOP Recovery</strong>
                        <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-whoop-recovery','whoop_recovery.csv')"><i class="bi bi-download"></i> CSV</button>
                    </div>
                    <div class="table-responsive scroll-shadow">
                        <table id="tbl-whoop-recovery" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>user_calibrating</th><th>recovery_score</th><th>resting_heart_rate</th><th>hrv_rmssd_milli</th><th>spo2_percentage</th><th>skin_temp_celsius</th>
                            </tr></thead>
                            <tbody>
                            <tr th:each="r : ${whoopRecovery}">
                                <td th:text="${r.user_calibrating}">false</td>
                                <td th:text="${#numbers.formatDecimal(r.recovery_score, 1, 2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(r.resting_heart_rate, 1, 2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(r.hrv_rmssd_milli, 1, 2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(r.spo2_percentage, 1, 2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(r.skin_temp_celsius, 1, 2)}">0.00</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(whoopSleep)}" class="alert alert-info">Нет данных по WHOOP sleep.</div>
                <div th:if="${not #lists.isEmpty(whoopSleep)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>WHOOP Sleep</strong>
                        <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-whoop-sleep','whoop_sleep.csv')"><i class="bi bi-download"></i> CSV</button>
                    </div>
                    <div class="table-responsive scroll-shadow">
                        <table id="tbl-whoop-sleep" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>start</th><th>enddate</th><th>timezone_offset</th><th>score_state</th><th>nap</th>
                                <th>total_in_bed_time_milli</th><th>total_awake_time_milli</th><th>total_no_data_time_milli</th>
                                <th>total_light_sleep_time_milli</th><th>total_slow_wave_sleep_time_milli</th><th>total_rem_sleep_time_milli</th>
                                <th>sleep_cycle_count</th><th>disturbance_count</th>
                                <th>baseline_milli</th><th>need_from_sleep_debt_milli</th><th>need_from_recent_strain_milli</th><th>need_from_recent_nap_milli</th>
                                <th>respiratory_rate</th><th>sleep_performance_percentage</th><th>sleep_consistency_percentage</th><th>sleep_efficiency_percentage</th>
                            </tr></thead>
                            <tbody>
                            <tr th:each="s : ${whoopSleep}">
                                <td th:text="${s.start != null ? #temporals.format(s.start,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${s.enddate != null ? #temporals.format(s.enddate,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${s.timezone_offset}">+05:00</td>
                                <td th:text="${s.score_state}">SCORED</td>
                                <td th:text="${s.nap}">false</td>
                                <td th:text="${s.total_in_bed_time_milli}">0</td>
                                <td th:text="${s.total_awake_time_milli}">0</td>
                                <td th:text="${s.total_no_data_time_milli}">0</td>
                                <td th:text="${s.total_light_sleep_time_milli}">0</td>
                                <td th:text="${s.total_slow_wave_sleep_time_milli}">0</td>
                                <td th:text="${s.total_rem_sleep_time_milli}">0</td>
                                <td th:text="${s.sleep_cycle_count}">0</td>
                                <td th:text="${s.disturbance_count}">0</td>
                                <td th:text="${s.baseline_milli}">0</td>
                                <td th:text="${s.need_from_sleep_debt_milli}">0</td>
                                <td th:text="${s.need_from_recent_strain_milli}">0</td>
                                <td th:text="${s.need_from_recent_nap_milli}">0</td>
                                <td th:text="${#numbers.formatDecimal(s.respiratory_rate,1,2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(s.sleep_performance_percentage,1,2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(s.sleep_consistency_percentage,1,2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(s.sleep_efficiency_percentage,1,2)}">0.00</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(whoopWorkout)}" class="alert alert-info">Нет данных по WHOOP workout.</div>
                <div th:if="${not #lists.isEmpty(whoopWorkout)}" class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>WHOOP Workouts</strong>
                        <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-whoop-workout','whoop_workout.csv')"><i class="bi bi-download"></i> CSV</button>
                    </div>
                    <div class="table-responsive scroll-shadow">
                        <table id="tbl-whoop-workout" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>start</th><th>enddate</th><th>timezone_offset</th><th>score_state</th><th>sport_name</th>
                                <th>strain</th><th>average_heart_rate</th><th>max_heart_rate</th><th>kilojoule</th><th>percent_recorded</th>
                                <th>distance_meter</th><th>altitude_gain_meter</th><th>altitude_change_meter</th>
                            </tr></thead>
                            <tbody>
                            <tr th:each="w : ${whoopWorkout}">
                                <td th:text="${w.start != null ? #temporals.format(w.start, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${w.enddate != null ? #temporals.format(w.enddate, 'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${w.timezone_offset}">+05:00</td>
                                <td th:text="${w.score_state}">SCORED</td>
                                <td th:text="${w.sport_name}">-</td>
                                <td th:text="${#numbers.formatDecimal(w.strain,1,2)}">0.00</td>
                                <td th:text="${w.average_heart_rate}">0</td>
                                <td th:text="${w.max_heart_rate}">0</td>
                                <td th:text="${#numbers.formatDecimal(w.kilojoule,1,2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(w.percent_recorded,1,2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(w.distance_meter,1,2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(w.altitude_gain_meter,1,2)}">0.00</td>
                                <td th:text="${#numbers.formatDecimal(w.altitude_change_meter,1,2)}">0.00</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- POLAR -->
        <div class="tab-pane fade show active"  th:if="${patient.device=='polar'}"  id="polar-pane" role="tabpanel" aria-labelledby="polar-tab">
            <div th:if="${patient.device == 'polar' and patient.status == 'active'}" class="d-flex flex-column gap-3">
                <!-- POLAR SUMMARY (опционально: краткая карточка профиля) -->
                <div th:if="${polarUserInfo != null}" class="card">
                    <div class="card-header"><strong>Polar User</strong></div>
                    <div class="card-body d-flex gap-4 flex-wrap">
                        <div><b>User ID:</b> <span th:text="${polarUserInfo.polarUserId}">-</span></div>
                        <div><b>Name:</b> <span th:text="${polarUserInfo.firstName}">-</span> <span th:text="${polarUserInfo.lastName}">-</span></div>
                        <div><b>Gender:</b> <span th:text="${polarUserInfo.gender}">-</span></div>
                        <div><b>DOB:</b> <span th:text="${polarUserInfo.birthdate}">-</span></div>
                        <div><b>Height (cm):</b> <span th:text="${polarUserInfo.heightCm}">-</span></div>
                        <div><b>Weight (kg):</b> <span th:text="${polarUserInfo.weightKg}">-</span></div>
                        <div><b>Registered:</b> <span th:text="${polarUserInfo.registrationDate != null ? #temporals.format(polarUserInfo.registrationDate, 'yyyy-MM-dd HH:mm') : '-'}">-</span></div>
                    </div>
                </div>

                <!-- POLAR Activities -->
                <div th:if="${#lists.isEmpty(polarActivities)}" class="alert alert-info mt-3">Нет активностей Polar за выбранный период.</div>
                <div th:if="${not #lists.isEmpty(polarActivities)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Activities (daily)</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-activities','polar_activities.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-activities-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-activities-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-activities" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Начало</th>
                                <th>Конец</th>
                                <th>Active</th>
                                <th>Inactive</th>
                                <th>Daily act</th>
                                <th>Calories</th>
                                <th>Active cal</th>
                                <th>Steps</th>
                                <th>Inact alerts</th>
                                <th>Distance (m)</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="a : ${polarActivities}">
                                <td th:text="${a.start_time != null ? #temporals.format(a.start_time,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${a.end_time != null ? #temporals.format(a.end_time,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${a.active_duration}">PT0S</td>
                                <td th:text="${a.inactive_duration}">PT0S</td>
                                <td th:text="${#numbers.formatDecimal(a.daily_activity,1,2)}">0.00</td>
                                <td th:text="${a.calories}">0</td>
                                <td th:text="${a.active_calories}">0</td>
                                <td th:text="${a.steps}">0</td>
                                <td th:text="${a.inactivity_alert_count}">0</td>
                                <td th:text="${#numbers.formatDecimal(a.distance_from_steps,1,2)}">0.00</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- POLAR Cardio Load -->
                <div th:if="${#lists.isEmpty(polarCardio)}" class="alert alert-info mt-3">Нет данных Cardio Load.</div>
                <div th:if="${not #lists.isEmpty(polarCardio)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Cardio Load</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-cardio','polar_cardio.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-cardio-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-cardio-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-cardio" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Status</th>
                                <th>Ratio</th>
                                <th>Cardio load</th>
                                <th>Strain</th>
                                <th>Tolerance</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="c : ${polarCardio}">
                                <td th:text="${c.date != null ? #temporals.format(c.date,'yyyy-MM-dd') : '-'}">-</td>
                                <td th:text="${c.cardio_load_status}">-</td>
                                <td th:text="${#numbers.formatDecimal(c.cardio_load_ratio,1,3)}">0.000</td>
                                <td th:text="${#numbers.formatDecimal(c.cardio_load,1,3)}">0.000</td>
                                <td th:text="${#numbers.formatDecimal(c.strain,1,3)}">0.000</td>
                                <td th:text="${#numbers.formatDecimal(c.tolerance,1,3)}">0.000</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- POLAR Exercises -->
                <div th:if="${#lists.isEmpty(polarExercises)}" class="alert alert-info mt-3">Нет тренировок (Exercises).</div>
                <div th:if="${not #lists.isEmpty(polarExercises)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Exercises</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-ex','polar_exercises.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-ex-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-ex-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-ex" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Upload</th>
                                <th>Start</th>
                                <th>Offset (min)</th>
                                <th>Device</th>
                                <th>Device ID</th>
                                <th>Duration</th>
                                <th>Distance</th>
                                <th>Sport</th>
                                <th>Route</th>
                                <th>Detail</th>
                                <th>Avg HR</th>
                                <th>Max HR</th>
                                <th>Calories</th>
                                <th>Fat %</th>
                                <th>Carb %</th>
                                <th>Prot %</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="e : ${polarExercises}">
                                <td th:text="${e.upload_time != null ? #temporals.format(e.upload_time,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${e.start_time != null ? #temporals.format(e.start_time,'yyyy-MM-dd HH:mm:ss') : '-'}">-</td>
                                <td th:text="${e.start_time_utc_offset}">0</td>
                                <td th:text="${e.device}">-</td>
                                <td th:text="${e.device_id}">-</td>
                                <td th:text="${e.duration}">PT0S</td>
                                <td th:text="${#numbers.formatDecimal(e.distance,1,3)}">0.000</td>
                                <td th:text="${e.sport}">-</td>
                                <td th:text="${e.has_route ? 'Да' : 'Нет'}">Нет</td>
                                <td th:text="${e.detailed_sport_info}">-</td>
                                <td th:text="${e.average_heart_rate}">-</td>
                                <td th:text="${e.max_heart_rate}">-</td>
                                <td th:text="${e.calories}">-</td>
                                <td th:text="${e.fat_percentage}">-</td>
                                <td th:text="${e.carbohydrate_percentage}">-</td>
                                <td th:text="${e.protein_percentage}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- POLAR Heart Rate (CHR Samples) -->
                <div th:if="${#lists.isEmpty(polarHeartRate)}" class="alert alert-info mt-3">Нет CHR сэмплов пульса.</div>
                <div th:if="${not #lists.isEmpty(polarHeartRate)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Heart Rate (CHR)</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-hr','polar_hr.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-hr-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-hr-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-hr" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Время</th>
                                <th>BPM</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="h : ${polarHeartRate}">
                                <td th:text="${h.date}">-</td>
                                <td th:text="${h.sampleTime}">-</td>
                                <td th:text="${h.bpm}">0</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- POLAR Nightly Recharge -->
                <div th:if="${#lists.isEmpty(polarNightRecharge)}" class="alert alert-info mt-3">Нет Nightly Recharge.</div>
                <div th:if="${not #lists.isEmpty(polarNightRecharge)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Nightly Recharge</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-nr','polar_nightly_recharge.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-nr-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-nr-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-nr" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Дата</th>
                                <th>HR avg</th>
                                <th>BB avg</th>
                                <th>HRV avg</th>
                                <th>Breathing avg</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="n : ${polarNightRecharge}">
                                <td th:text="${n.date != null ? #temporals.format(n.date,'yyyy-MM-dd') : '-'}">-</td>
                                <td th:text="${n.heart_rate_avg}">0</td>
                                <td th:text="${n.beat_to_beat_avg}">0</td>
                                <td th:text="${n.heart_rate_variability_avg}">0</td>
                                <td th:text="${#numbers.formatDecimal(n.breathing_rate_avg,1,3)}">0.000</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                <div th:if="${#lists.isEmpty(polarSleep)}" class="alert alert-info mt-3">Нет данных сна.</div>
                <div th:if="${not #lists.isEmpty(polarSleep)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Sleep</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-sleep','polar_sleep.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-sleep-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-sleep-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-sleep" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Начало</th>
                                <th>Конец</th>
                                <th>Device</th>
                                <th>Continuity</th>
                                <th>Class</th>
                                <th>Light</th>
                                <th>Deep</th>
                                <th>REM</th>
                                <th>Unrec.</th>
                                <th>Score</th>
                                <th>Goal</th>
                                <th>Rating</th>
                                <th>Interr. total</th>
                                <th>Short</th>
                                <th>Long</th>
                                <th>Cycles</th>
                                <th>Dur score</th>
                                <th>Solidity</th>
                                <th>Regen</th>
                                <th>Hypnogram</th>
                                <th>HR samples</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="s : ${polarSleep}">
                                <td th:text="${s.date}">-</td>
                                <td th:text="${s.sleepStartTime != null ? #temporals.format(s.sleepStartTime,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${s.sleepEndTime != null ? #temporals.format(s.sleepEndTime,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${s.deviceId}">-</td>

                                <td th:text="${s.continuity != null ? #numbers.formatDecimal(s.continuity,1,3) : '-'}">-</td>
                                <td th:text="${s.continuityClass}">-</td>

                                <td th:text="${s.lightSleep}">0</td>
                                <td th:text="${s.deepSleep}">0</td>
                                <td th:text="${s.remSleep}">0</td>
                                <td th:text="${s.unrecognizedSleepStage}">0</td>

                                <td th:text="${s.sleepScore}">0</td>
                                <td th:text="${s.sleepGoal}">0</td>
                                <td th:text="${s.sleepRating}">0</td>

                                <td th:text="${s.totalInterruptionDuration}">0</td>
                                <td th:text="${s.shortInterruptionDuration}">0</td>
                                <td th:text="${s.longInterruptionDuration}">0</td>

                                <td th:text="${s.sleepCycles}">0</td>

                                <td th:text="${s.groupDurationScore}">0</td>
                                <td th:text="${s.groupSolidityScore}">0</td>
                                <td th:text="${s.groupRegenerationScore != null ? #numbers.formatDecimal(s.groupRegenerationScore,1,3) : '-'}">-</td>

                                <!-- длинные JSON поля аккуратно усечём -->
                                <td class="text-truncate" style="max-width:240px"
                                    th:title="${s.hypnogramJson}"
                                    th:text="${s.hypnogramJson}">-</td>
                                <td class="text-truncate" style="max-width:240px"
                                    th:title="${s.heartRateSamplesJson}"
                                    th:text="${s.heartRateSamplesJson}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(polarHypnograms)}" class="alert alert-info mt-3">Нет данных о гипнограмме сна.</div>
                <div th:if="${not #lists.isEmpty(polarHypnograms)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Hypnograms</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-hypnosleep','polar_hypnosleep.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-hypnosleep-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-hypnosleep-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-hypnosleep" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Время</th>
                                <th>Тип сна</th>

                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="s : ${polarHypnograms}">
                                <td th:text="${s.sleepTime}">-</td>
                                <td th:text="${s.typeName}">-</td>

                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                <div th:if="${#lists.isEmpty(polarHeartRateSamplesSleeps)}" class="alert alert-info mt-3">Нет данных о сердцебиении во время сна.</div>
                <div th:if="${not #lists.isEmpty(polarHeartRateSamplesSleeps)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar HR sleep</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-hrsleep','polar_hrsleep.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-hrsleep-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-hrleep-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-hrsleep" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Время</th>
                                <th>Значение</th>

                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="s : ${polarHeartRateSamplesSleeps}">
                                <td th:text="${s.sleepTime}">-</td>
                                <td th:text="${s.valueHr}">-</td>

                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- POLAR SpO2 -->
                <div th:if="${#lists.isEmpty(polarSpo)}" class="alert alert-info mt-3">Нет данных SpO₂.</div>
                <div th:if="${not #lists.isEmpty(polarSpo)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar SpO₂</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-spo2','polar_spo2.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-spo2-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-spo2-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-spo2" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Start</th>
                                <th>End</th>
                                <th>SpO₂ %</th>
                                <th>Avg HR</th>
                                <th>HRV (ms)</th>
                                <th>Class</th>
                                <th>Status</th>
                                <th>Altitude</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="o : ${polarSpo}">
                                <td th:text="${o.start_time != null ? #temporals.format(o.start_time,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${o.end_time != null ? #temporals.format(o.end_time,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${o.blood_oxygen_percent}">-</td>
                                <td th:text="${o.average_heart_rate_bpm}">-</td>
                                <td th:text="${#numbers.formatDecimal(o.heart_rate_variability_ms,1,3)}">-</td>
                                <td th:text="${o.spo2_class}">-</td>
                                <td th:text="${o.test_status}">-</td>
                                <td th:text="${#numbers.formatDecimal(o.altitude_meters,1,2)}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- POLAR Temperature (aggregate) -->
                <div th:if="${#lists.isEmpty(polarTemperature)}" class="alert alert-info mt-3">Нет данных температуры.</div>
                <div th:if="${not #lists.isEmpty(polarTemperature)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Body Temperature (sessions)</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-temp','polar_temperature.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-temp-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-temp-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-temp" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Start</th>
                                <th>End</th>
                                <th>Device</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Samples (raw)</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="t : ${polarTemperature}">
                                <td th:text="${t.startTime != null ? #temporals.format(t.startTime,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${t.endTime != null ? #temporals.format(t.endTime,'yyyy-MM-dd HH:mm') : '-'}">-</td>
                                <td th:text="${t.source_device_id}">-</td>
                                <td th:text="${t.measurement_type}">-</td>
                                <td th:text="${t.sensor_location}">-</td>
                                <td class="text-truncate" style="max-width: 300px;" th:text="${t.samples}">[]</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- POLAR Temperature Samples (expanded points) -->
                <div th:if="${#lists.isEmpty(polarTemperatureSamples)}" class="alert alert-info mt-3">Нет сэмплов температуры.</div>
                <div th:if="${not #lists.isEmpty(polarTemperatureSamples)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar Temperature Samples</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-temp-samples','polar_temperature_samples.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-temp-samples-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-temp-samples-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-temp-samples" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Time</th>
                                <th>Value</th>
                                <th>Unit</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="s : ${polarTemperatureSamples}">
                                <td th:text="${s.sampleTime != null ? #temporals.format(s.sampleTime,'yyyy-MM-dd HH:mm:ss') : '-'}">-</td>
                                <td th:text="${#numbers.formatDecimal(s.value,1,3)}">0.000</td>
                                <td th:text="${s.unit}">C</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- POLAR ECG Tests -->
                <div th:if="${#lists.isEmpty(polarTestEcg)}" class="alert alert-info mt-3">Нет тестов ЭКГ.</div>
                <div th:if="${not #lists.isEmpty(polarTestEcg)}" class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Polar ECG</strong>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light" onclick="exportTable('#tbl-polar-ecg','polar_ecg.csv')"><i class="bi bi-download"></i> CSV</button>
                            <button class="btn btn-sm btn-outline-light" data-density-toggle data-target="#tbl-polar-ecg-wrap"><i class="bi bi-arrows-vertical"></i> Плотнее</button>
                        </div>
                    </div>
                    <div id="tbl-polar-ecg-wrap" class="table-responsive scroll-shadow">
                        <table id="tbl-polar-ecg" class="table table-sm table-striped table-hover align-middle table-fit">
                            <thead>
                            <tr>
                                <th>Start</th>
                                <th>End</th>
                                <th>Avg HR</th>
                                <th>HRV ms</th>
                                <th>HRV level</th>
                                <th>PTT sys</th>
                                <th>PTT dia</th>
                                <th>PTT QI</th>
                                <th>Device</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="e : ${polarTestEcg}">
                                <td th:text="${e.start_time != null ? #temporals.format(e.start_time,'yyyy-MM-dd HH:mm:ss') : '-'}">-</td>
                                <td th:text="${e.end_time != null ? #temporals.format(e.end_time,'yyyy-MM-dd HH:mm:ss') : '-'}">-</td>
                                <td th:text="${e.average_heart_rate_bpm}">-</td>
                                <td th:text="${#numbers.formatDecimal(e.heart_rate_variability_ms,1,3)}">-</td>
                                <td th:text="${e.heart_rate_variability_level}">-</td>
                                <td th:text="${#numbers.formatDecimal(e.pulse_transit_time_systolic_ms,1,3)}">-</td>
                                <td th:text="${#numbers.formatDecimal(e.pulse_transit_time_diastolic_ms,1,3)}">-</td>
                                <td th:text="${#numbers.formatDecimal(e.pulse_transit_time_quality_index,1,3)}">-</td>
                                <td th:text="${e.source_device_id}">-</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Скрытая форма sync (оставлена как есть) -->
    <form id="syncForm" th:action="@{/patients/{id}/{provider}/sync(id=${patient.id}, provider='oura')}" method="post" class="d-none">
        <input type="hidden" name="type" id="syncType" value="sleep_daily">
        <input type="hidden" name="days" id="syncDays" value="7">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>

    <!-- Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080">
        <div id="inviteToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Приглашение</strong>
                <small class="text-muted">сейчас</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Закрыть"></button>
            </div>
            <div class="toast-body">—</div>
        </div>
    </div>
</div>

<!-- Vendor JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>

<script>
    // Копирование приглашений с тостами
    function copyInviteUrl(btn) {
        const url = btn.getAttribute('data-url');
        if (!url) return;
        btn.disabled = true; btn.classList.add('disabled');
        fetch(url, {method: 'GET', credentials: 'same-origin', headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
            .then(link => navigator.clipboard.writeText(link)
                .then(() => showInviteToast('Ссылка приглашения скопирована.'))
                .catch(() => { prompt('Скопируйте ссылку вручную:', link); }))
            .catch(() => showInviteToast('Не удалось получить ссылку.'))
            .finally(() => { btn.disabled = false; btn.classList.remove('disabled'); });
    }
    function showInviteToast(message) {
        const el = document.getElementById('inviteToast');
        if (!el) { alert(message); return; }
        el.querySelector('.toast-body').textContent = message;
        const t = new bootstrap.Toast(el, {delay: 2500});
        t.show();
    }

    /* ===== Chart.js: сбор данных из скрытых span и построение ===== */
    function collectDataset(cls) {
        const nodes = Array.from(document.querySelectorAll('.' + cls));
        const labels = nodes.map(n => n.dataset.t);
        const values = nodes.map(n => Number(n.dataset.v)).filter(v => !Number.isNaN(v));
        return {labels, values};
    }
    function makeSparkline(canvasId, labels, values, opts = {}) {
        const el = document.getElementById(canvasId);
        if (!el || !values || values.length === 0) return;
        new Chart(el.getContext('2d'), {
            type: 'line',
            data: {labels, datasets: [{data: values, fill: false, borderWidth: 2, tension: 0.35, pointRadius: 0}]},
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: {display: false}, tooltip: {callbacks: {label: (c) => (opts.unit ? `${c.parsed.y} ${opts.unit}` : `${c.parsed.y}`)}} },
                scales: {x: {display: false}, y: {display: false, suggestedMin: opts.min, suggestedMax: opts.max}},
                elements: {line: {borderJoinStyle: 'round', borderCapStyle: 'round'}}
            }
        });
    }
    // HR графики
    (function () {
        const {labels, values} = collectDataset('hr-point');
        if (values.length) { makeSparkline('hrSpark', labels, values, {}); }
    })();
    // SpO2 графики
    (function () {
        const {labels, values} = collectDataset('spo2-point');
        if (values.length) {
            const min = Math.min(...values) - 0.5, max = Math.max(...values) + 0.5;
            makeSparkline('spo2SparkBig', labels, values, {unit: '%', min, max});
        }
    })();
    // Мини-спарклайны для шагов/готовности/сна
    (function () {
        const steps = Array.from(document.querySelectorAll('.steps-point'));
        if (steps.length) {
            makeSparkline('stepsSpark', steps.map(n => n.dataset.t), steps.map(n => Number(n.dataset.v)));
        }
        const ready = Array.from(document.querySelectorAll('.readiness-point'));
        if (ready.length) {
            makeSparkline('readinessSpark', ready.map(n => n.dataset.t), ready.map(n => Number(n.dataset.v)));
        }
        const sleep = Array.from(document.querySelectorAll('.sleep-point'));
        if (sleep.length) {
            makeSparkline('sleepSpark', sleep.map(n => n.dataset.t), sleep.map(n => Number(n.dataset.v)));
        }
    })();

    // Экспорт таблицы в CSV (простая версия по innerText)
    function exportTable(selector, filename = 'export.csv') {
        const table = document.querySelector(selector);
        if (!table) return;
        const rows = Array.from(table.querySelectorAll('tr')).map(tr => Array.from(tr.children).map(td => {
            let t = td.innerText.replaceAll('\n', ' ').trim();
            if (t.includes('"') || t.includes(',') || t.includes(';')) t = '"' + t.replaceAll('"','""') + '"';
            return t;
        }).join(','));
        const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    // Переключатель плотности строк (compact mode)
    document.querySelectorAll('[data-density-toggle]').forEach(btn => {
        btn.addEventListener('click', () => {
            const wrap = document.querySelector(btn.getAttribute('data-target'));
            if (!wrap) return;
            wrap.classList.toggle('table-compact');
            btn.classList.toggle('active');
        });
    });
</script>
</body>
</html>