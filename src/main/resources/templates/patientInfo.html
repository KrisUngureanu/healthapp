<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout.html}">
<head>
    <title>Patient</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .btn-gradient {
            background: linear-gradient(90deg, #4364f7, #6fb1fc);
            border: none;
            color: #fff
        }

        .btn-gradient:hover {
            background: linear-gradient(90deg, #6fb1fc, #4364f7);
            color: #fff
        }

        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .15)
        }

        .card-header {
            border-radius: 1rem 1rem 0 0;
            background: linear-gradient(90deg, #4364f7, #6fb1fc);
            color: #fff
        }

        .badge-soft {
            background: rgba(255, 255, 255, .2);
            border: 1px solid rgba(255, 255, 255, .35)
        }

        .stat {
            border-radius: .75rem;
            background: #f8f9ff;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: .75rem;
        }

        .stat .num {
            font-weight: 700;
            font-size: 1.25rem
        }

        .nav-pills .nav-link {
            border-radius: 2rem
        }
    </style>
</head>
<body>
<div layout:fragment="mainFragment" th:with="st=${(patient.status ?: '').toLowerCase()}">

    <!-- Header -->
    <div class="card mb-4">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <a th:href="@{/}" class="btn btn-sm btn-light border">← Back</a>
                <div>
                    <h4 class="mb-0" th:text="${patient.fullname}">Patient Name</h4>
                    <small class="opacity-75">ID: <span th:text="${patient.id}">1</span></small>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2">
        <span class="badge status-badge"
              th:with="st=${(patient.status ?: '').toLowerCase()}"
              th:text="${st != '' ? patient.status : '—'}"
              th:classappend="${st == 'active'} ? ' bg-success'
                      : (st == 'critical' ? ' bg-danger' : ' bg-secondary')">
  Статус
</span>

                <!-- Actions (doctor/admin only) -->
                <div sec:authorize="hasAnyRole('DOCTOR','ADMIN')" class="d-flex gap-2">
                    <form th:action="@{/patients/{id}/integrations/{provider}/syncAll(id=${patient.id}, provider='oura')}"
                          method="post" class="d-flex gap-2 mt-2"><input type="number" min="1" max="30"
                                                                         name="days" value="7"
                                                                         class="form-control"
                                                                         style="max-width:120px">
                        <button class="btn btn-gradient">Синхронизировать</button>
                    </form>

                    <!-- Disconnect / Invite -->
                    <form th:if="${st == 'active'}"
                          th:action="@{/patients/{id}/{provider}/disconnect(id=${patient.id}, provider='oura')}"
                          method="post" class="mb-0">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn btn-outline-light">Disconnect Oura</button>
                    </form>

                    <div th:if="${st != 'active'}" class="d-flex gap-2">
                        <button type="button"
                                class="btn btn-outline-light"
                                th:attr="data-url=@{/patients/{id}/oura/invite(id=${patient.id})}"
                                onclick="copyInviteUrl(this)">
                            Copy invite link
                        </button>
                        <a class="btn btn-light"
                           th:href="@{/patients/{id}/oura/invite(id=${patient.id})}"
                           target="_blank">Open invite</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Small stats row -->
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6 col-md-3">
                    <div class="stat">
                        <div class="num"
                             th:text="${#lists.isEmpty(m.activityDaily) ? '—' : (m.activityDaily.get(0).steps != null ? m.activityDaily.get(0).steps : '—')}">
                            —
                        </div>
                        <div>Steps<br><small class="text-muted">today</small></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat">
                        <div class="num"
                             th:text="${#lists.isEmpty(m.readinessDaily) ? '—' : (m.readinessDaily.get(0).score != null ? m.readinessDaily.get(0).score : '—')}">
                            —
                        </div>
                        <div>Readiness<br><small class="text-muted">score</small></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat">
                        <div class="num"
                             th:text="${#lists.isEmpty(m.sleepDaily) ? '—' : (m.sleepDaily.get(0).totalSleepSec != null ? m.sleepDaily.get(0).totalSleepSec/60 : '—')}">
                            —
                        </div>
                        <div>Sleep<br><small class="text-muted">min today</small></div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="stat">
                        <div class="num"
                             th:text="${#lists.isEmpty(m.hr) ? '—' : (m.hr.get(m.hr.size()-1).bpm)}">—
                        </div>
                        <div>Last HR<br><small class="text-muted"
                                               th:text="${#lists.isEmpty(m.hr) ? '' : T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(m.hr.get(m.hr.size()-1).ts, m.zone)}">—</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3 justify-content-center" id="patientTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-overview" data-bs-toggle="tab" data-bs-target="#pane-overview"
                    type="button" role="tab">Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-series" data-bs-toggle="tab" data-bs-target="#pane-series" type="button"
                    role="tab">Time Series
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-daily" data-bs-toggle="tab" data-bs-target="#pane-daily" type="button"
                    role="tab">Daily
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-sessions" data-bs-toggle="tab" data-bs-target="#pane-sessions"
                    type="button" role="tab">Sessions
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- Overview -->
        <div class="tab-pane fade show active" id="pane-overview" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Heart Rate — Today</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.hr)}" class="alert alert-warning mb-0">No heart rate data for
                                today.
                            </div>
                            <div th:if="${!#lists.isEmpty(m.hr)}" class="table-responsive">
                                <table class="table table-sm table-hover align-middle">
                                    <thead>
                                    <tr>
                                        <th>Provider</th>
                                        <th>Time</th>
                                        <th>BPM</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="h : ${m.hr}">
                                        <td th:text="${h.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(h.ts, m.zone)}">
                                            12:34
                                        </td>
                                        <td th:text="${h.bpm}">62</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">SpO₂ — Today</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.spo2)}" class="alert alert-warning mb-0">No SpO₂ data for
                                today.
                            </div>
                            <div th:if="${!#lists.isEmpty(m.spo2)}" class="table-responsive">
                                <table class="table table-sm table-hover align-middle">
                                    <thead>
                                    <tr>
                                        <th>Provider</th>
                                        <th>Time</th>
                                        <th>SpO₂ %</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="s : ${m.spo2}">
                                        <td th:text="${s.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(s.ts, m.zone)}">
                                            00:00
                                        </td>
                                        <td th:text="${#numbers.formatDecimal(s.spo2Pct,1,1)}">96.4</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Time Series -->
        <div class="tab-pane fade" id="pane-series" role="tabpanel">
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Heart Rate — Today</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.hr)}" class="alert alert-warning mb-0">No heart rate data.
                            </div>
                            <div th:if="${!#lists.isEmpty(m.hr)}" class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                    <tr>
                                        <th>Provider</th>
                                        <th>Time</th>
                                        <th>BPM</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="h : ${m.hr}">
                                        <td th:text="${h.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(h.ts, m.zone)}">
                                            12:34
                                        </td>
                                        <td th:text="${h.bpm}">62</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">SpO₂ — Today</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.spo2)}" class="alert alert-warning mb-0">No SpO₂ data.</div>
                            <div th:if="${!#lists.isEmpty(m.spo2)}" class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                    <tr>
                                        <th>Provider</th>
                                        <th>Time</th>
                                        <th>SpO₂ %</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="s : ${m.spo2}">
                                        <td th:text="${s.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(s.ts, m.zone)}">
                                            00:00
                                        </td>
                                        <td th:text="${#numbers.formatDecimal(s.spo2Pct,1,1)}">96.4</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Daily -->
        <div class="tab-pane fade" id="pane-daily" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Activity (daily)</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.activityDaily)}" class="text-muted">No activity daily.</div>
                            <ul class="list-unstyled mb-0" th:each="a : ${m.activityDaily}">
                                <li class="mb-2">
                                    <span class="badge text-bg-secondary" th:text="${a.provider}">OURA</span>
                                    Steps: <b th:text="${a.steps != null ? a.steps : 0}">0</b>,
                                    Calories: <b th:text="${a.caloriesActive != null ? a.caloriesActive : 0}">0</b>,
                                    Distance(m): <b th:text="${a.distanceM != null ? a.distanceM : 0}">0</b>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Readiness (daily)</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.readinessDaily)}" class="text-muted">No readiness daily.
                            </div>
                            <ul class="list-unstyled mb-0" th:each="r : ${m.readinessDaily}">
                                <li class="mb-2">
                                    <span class="badge text-bg-secondary" th:text="${r.provider}">OURA</span>
                                    Score: <b th:text="${r.score != null ? r.score : '—'}">—</b>,
                                    RHR: <b th:text="${r.rhrBpm != null ? r.rhrBpm : '—'}">—</b>,
                                    HRV(ms): <b th:text="${r.hrvAvgMs != null ? r.hrvAvgMs : '—'}">—</b>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Sleep (daily)</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.sleepDaily)}" class="text-muted">No sleep daily.</div>
                            <ul class="list-unstyled mb-0" th:each="s : ${m.sleepDaily}">
                                <li class="mb-2">
                                    <span class="badge text-bg-secondary" th:text="${s.provider}">OURA</span>
                                    Score: <b th:text="${s.score != null ? s.score : '—'}">—</b>,
                                    Total sleep (min): <b th:text="${s.totalSleepSec != null ? s.totalSleepSec/60 : 0}">0</b>,
                                    HRV(ms): <b th:text="${s.hrvAvgMs != null ? s.hrvAvgMs : '—'}">—</b>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sessions -->
        <div class="tab-pane fade" id="pane-sessions" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Workouts — Today</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.activitySessions)}" class="alert alert-info mb-0">No workouts
                                today.
                            </div>
                            <div th:if="${!#lists.isEmpty(m.activitySessions)}" class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                    <tr>
                                        <th>Provider</th>
                                        <th>Start</th>
                                        <th>End</th>
                                        <th>Sport</th>
                                        <th>Avg HR</th>
                                        <th>Cal</th>
                                        <th>Dist(m)</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="w : ${m.activitySessions}">
                                        <td th:text="${w.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(w.startTime, m.zone)}">
                                            08:15
                                        </td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(w.endTime, m.zone)}">
                                            09:05
                                        </td>
                                        <td th:text="${w.sportType}">run</td>
                                        <td th:text="${w.avgHr}">132</td>
                                        <td th:text="${w.calories}">450</td>
                                        <td th:text="${w.distanceM}">6000</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header"><h6 class="mb-0">Sleep Sessions — Today</h6></div>
                        <div class="card-body">
                            <div th:if="${#lists.isEmpty(m.sleepSessions)}" class="alert alert-info mb-0">No sleep
                                sessions starting today.
                            </div>
                            <div th:if="${!#lists.isEmpty(m.sleepSessions)}" class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                    <tr>
                                        <th>Provider</th>
                                        <th>Start</th>
                                        <th>End</th>
                                        <th>Score</th>
                                        <th>Dur(min)</th>
                                        <th>HRV</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="s : ${m.sleepSessions}">
                                        <td th:text="${s.provider}">OURA</td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(s.startTime, m.zone)}">
                                            23:41
                                        </td>
                                        <td th:text="${T(com.sportfd.healthapp.service.PatientMetricsService).fmtTime(s.endTime, m.zone)}">
                                            07:05
                                        </td>
                                        <td th:text="${s.score}">80</td>
                                        <td th:text="${s.durationSec != null ? s.durationSec/60 : '—'}">—</td>
                                        <td th:text="${s.hrvAvgMs}">45</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- Hidden sync form -->
    <form id="syncForm"
          th:action="@{/patients/{id}/{provider}/sync(id=${patient.id}, provider='oura')}"
          method="post" class="d-none">
        <input type="hidden" name="type" id="syncType" value="sleep_daily">
        <input type="hidden" name="days" id="syncDays" value="7">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>

    <!-- Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080">
        <div id="inviteToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Invite</strong>
                <small class="text-muted">now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">—</div>
        </div>
    </div>

</div>

<script>
    function copyInviteUrl(btn) {
        const url = btn.getAttribute('data-url');
        if (!url) return;
        btn.disabled = true;
        fetch(url, {method: 'GET', credentials: 'same-origin', headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(r => {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.text();
            })
            .then(link => navigator.clipboard.writeText(link)
                .then(() => showInviteToast('Invite link copied.'))
                .catch(() => {
                    prompt('Copy the link manually:', link);
                }))
            .catch(() => showInviteToast('Failed to get the link.'))
            .finally(() => {
                btn.disabled = false;
            });
    }

    function showInviteToast(message) {
        const el = document.getElementById('inviteToast');
        if (!el) {
            alert(message);
            return;
        }
        el.querySelector('.toast-body').textContent = message;
        const t = new bootstrap.Toast(el, {delay: 2500});
        t.show();
    }

    function submitSync(type, days = 7) {
        document.getElementById('syncType').value = type;
        document.getElementById('syncDays').value = days;
        document.getElementById('syncForm').submit();
    }
</script>
</body>
</html>
