<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>SportFD • Сон (7 дней)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">SportFD</a>
    </div>
</nav>

<main class="container my-4">
    <h1 class="mb-4">Сон пациента — последние 7 дней</h1>

    <div class="row g-3 mb-4">
        <div class="col-sm-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Записей</div>
                    <div class="fs-3" th:text="${count}">0</div>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Средний score</div>
                    <div class="fs-3" th:text="${avgScore}">0</div>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Последняя запись</div>
                    <div class="fs-6"
                         th:text="${lastStartTime != null ? #temporals.format(lastStartTime, 'dd.MM.yyyy HH:mm') : '—'}">—</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Детали сна</h5>
            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                    <tr>
                        <th>Начало</th>
                        <th>Конец</th>
                        <th>Длительность</th>
                        <th>Score</th>
                        <th>Стадии (JSON)</th>
                        <th>Провайдер</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="s : ${items}">
                        <td th:text="${#temporals.format(s.startTime, 'dd.MM HH:mm')}">—</td>
                        <td th:text="${#temporals.format(s.endTime, 'dd.MM HH:mm')}">—</td>
                        <td th:text="${#numbers.formatInteger(#temporals.duration(s.startTime, s.endTime).toMinutes(), 0)} + ' мин'">—</td>
                        <td th:text="${s.score}">—</td>
                        <td><code th:text="${s.stagesJson}">—</code></td>
                        <td th:text="${s.provider}">—</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">График sleep score</h5>
            <canvas id="sleepScoreChart" height="120"></canvas>
        </div>
    </div>
</main>

<footer class="text-center text-muted py-4">
    <small>© 2025 SportFD</small>
</footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    const labels = /*[[${labels}]]*/ [];
    const scores = /*[[${scores}]]*/ [];
    const ctx = document.getElementById('sleepScoreChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: { labels: labels.slice().reverse(), datasets: [{ label: 'Score', data: scores.slice().reverse(), tension: 0.3 }] },
        options: { responsive: true, scales: { y: { suggestedMin: 0, suggestedMax: 100 } } }
    });
    /*]]>*/
</script>
</body>
</html>
